<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 6: Geostatistics using Kriging</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-spatial_lag_error_regressions.html" rel="next">
<link href="./07-suitability_mapping_Niche.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-a14e345711173c227b21482e2eb4cc70.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-6d7e0e055978adcb0dc3bbe98a6d8351.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-a14e345711173c227b21482e2eb4cc70.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6b8658ecaa42f34dfb83e89c305171f2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-87f5ed8b884f981cef75eebe188fc88d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-6b8658ecaa42f34dfb83e89c305171f2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="assets/styles.css">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-suitability_mapping_AHP.html">Raster-Based Analysis</a></li><li class="breadcrumb-item"><a href="./08-geostatistics_kriging.html">Week 6: Geostatistics using Kriging</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="https://www.ucl.ac.uk/module-catalogue/modules/GEOG0114" class="sidebar-logo-link">
      <img src="./images/general/ucl_logo1.png" alt="" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="./images/general/ucl_logo1.png" alt="" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
    <div id="quarto-search" class="quarto-navigation-tool px-1" title="Search"></div>
</div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Module Overview</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-module_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-reading_list.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reading List for GEOG0114</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation of R and RStudio</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundation &amp; Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-spatial_analysis_for_data_science.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1: Spatial analysis for data sciences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-graphical_representation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2: Graphical representation of spatial data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-spatial_autocorrelation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3: Spatial autocorrelation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Raster-Based Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-suitability_mapping_AHP.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4: Multi-Decision Criteria Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-suitability_mapping_Niche.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5: Ecological Niche Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-geostatistics_kriging.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Week 6: Geostatistics using Kriging</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Spatial Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-spatial_lag_error_regressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 7: Spatial Lag &amp; Error Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-gwr_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 8: Geographically Weighted Regression (GWR)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-icar_bayesian_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 9: Spatial Bayesian Risk Modelling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Video Archive</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-video_achives.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2023-2024/25</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives"><span class="header-section-number">1.1</span> Learning objectives</a></li>
  <li><a href="#datasets-setting-up-the-work-directory" id="toc-datasets-setting-up-the-work-directory" class="nav-link" data-scroll-target="#datasets-setting-up-the-work-directory"><span class="header-section-number">1.2</span> Datasets &amp; setting up the work directory</a></li>
  <li><a href="#loading-and-installing-packages" id="toc-loading-and-installing-packages" class="nav-link" data-scroll-target="#loading-and-installing-packages"><span class="header-section-number">1.3</span> Loading and installing packages</a></li>
  <li><a href="#loading-datasets" id="toc-loading-datasets" class="nav-link" data-scroll-target="#loading-datasets"><span class="header-section-number">1.4</span> Loading datasets</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">1.5</span> Data preparation</a></li>
  <li><a href="#semivariogram-analysis" id="toc-semivariogram-analysis" class="nav-link" data-scroll-target="#semivariogram-analysis"><span class="header-section-number">1.6</span> Semivariogram analysis</a>
  <ul class="collapse">
  <li><a href="#plotting-the-empirical-semivariogram" id="toc-plotting-the-empirical-semivariogram" class="nav-link" data-scroll-target="#plotting-the-empirical-semivariogram"><span class="header-section-number">1.6.1</span> Plotting the Empirical Semivariogram</a></li>
  <li><a href="#plotting-the-theoretical-semivariogram" id="toc-plotting-the-theoretical-semivariogram" class="nav-link" data-scroll-target="#plotting-the-theoretical-semivariogram"><span class="header-section-number">1.6.2</span> Plotting the Theoretical Semivariogram</a></li>
  </ul></li>
  <li><a href="#kriging-modelling-null" id="toc-kriging-modelling-null" class="nav-link" data-scroll-target="#kriging-modelling-null"><span class="header-section-number">1.7</span> Kriging modelling (null)</a>
  <ul class="collapse">
  <li><a href="#building-a-blank-raster-template" id="toc-building-a-blank-raster-template" class="nav-link" data-scroll-target="#building-a-blank-raster-template"><span class="header-section-number">1.7.1</span> Building a blank raster template</a></li>
  <li><a href="#implementing-the-spatial-interpolation-on-blank-template-using-kriging" id="toc-implementing-the-spatial-interpolation-on-blank-template-using-kriging" class="nav-link" data-scroll-target="#implementing-the-spatial-interpolation-on-blank-template-using-kriging"><span class="header-section-number">1.7.2</span> Implementing the spatial interpolation on blank template using Kriging</a></li>
  <li><a href="#how-to-export-the-results-as-.tiff-format-thematic-visualisation-in-tmap" id="toc-how-to-export-the-results-as-.tiff-format-thematic-visualisation-in-tmap" class="nav-link" data-scroll-target="#how-to-export-the-results-as-.tiff-format-thematic-visualisation-in-tmap"><span class="header-section-number">1.7.3</span> How to export the results as .tiff format thematic visualisation in <code>tmap</code></a></li>
  <li><a href="#thematic-visualisation-of-raster-data-using-tmap" id="toc-thematic-visualisation-of-raster-data-using-tmap" class="nav-link" data-scroll-target="#thematic-visualisation-of-raster-data-using-tmap"><span class="header-section-number">1.7.4</span> Thematic visualisation of raster data using <code>tmap</code></a></li>
  </ul></li>
  <li><a href="#demonstrations-of-kriging-regression-model" id="toc-demonstrations-of-kriging-regression-model" class="nav-link" data-scroll-target="#demonstrations-of-kriging-regression-model"><span class="header-section-number">1.8</span> Demonstrations of Kriging regression model</a></li>
  <li><a href="#references-see-reading-list" id="toc-references-see-reading-list" class="nav-link" data-scroll-target="#references-see-reading-list"><span class="header-section-number">1.9</span> References (see reading list)</a></li>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources"><span class="header-section-number">1.10</span> Data Sources</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise"><span class="header-section-number">1.11</span> Exercise</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-suitability_mapping_AHP.html">Raster-Based Analysis</a></li><li class="breadcrumb-item"><a href="./08-geostatistics_kriging.html">Week 6: Geostatistics using Kriging</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Week 6: Geostatistics using Kriging</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Today, we will learn how to perform <strong>semivariogram</strong> analysis which can be used to create continuous predictive maps based on spatial interpolation technique called <strong>Kriging</strong>. In this session, we will investigate spatial variation in outcomes that are, in theory, <strong>spatially continuous</strong>; for example, the concentrations of ambient air pollutants such as Sulphur dioxide (<span class="math inline">\(SO_{2}\)</span>) (a toxic gas emitted from sulphur rich fuels (i.e., coal, oil or diesel) when burnt) which can be present anywhere but in practice are only measured at specified point locations, such as air quality monitoring stations.</p>
<p>We will assess for the presence of spatial autocorrelation using <strong>semivariogram</strong> which is distance-based, which describes the correlation of a variable with itself through geographic space. Here, a <strong>Positive Autocorrelation</strong> exists when measurements close to one another are alike than they would be due to chance or through random sampling. The presence of autocorrelation for spatially continuous phenomena can be established by using <strong>semivariograms</strong>.</p>
<p>Estimates from a semivariogram can be are used from model construction for spatial interpolation across a study area, whereby values at unsampled locations are predicted from neighbouring sites. A popular form of interpolation, which is based on the spatial attribute’s outcome variable, is known as <strong>Kriging</strong> (a technique named after a South African engineer, Danie G. Krige (1919 to 2013)).</p>
<section id="learning-objectives" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">1.1</span> Learning objectives</h2>
<p>The US Environmental Agency have positioned air quality monitors for surveillance of over 100 different types of pollutants that exist as toxic gases, particulates and heavy metals. For <strong>Sulphur Dioxide</strong> (<span class="math inline">\(SO_{2}\)</span>), there are 458 active air monitors that takes hourly readings for concentrations of <span class="math inline">\(SO_{2}\)</span> (in parts per billion (pbb)). An annual estimate for <span class="math inline">\(SO_{2}\)</span> was calculated for each station at its location. Car usage, urbanisation and social economic deprivation, alongside of other anthropogenic activities such as coal burning, across the USA increases the risk of elevated pollution of <span class="math inline">\(SO_{2}\)</span>.</p>
<p>Using geostatistical methods and taking into account of <strong>car usage, urbanisation and levels of deprivation</strong> - what areas in USA have higher concentrations of <span class="math inline">\(SO_{2}\)</span> exceeding the annual average of 40 ppb which is a national safety limit for cause of concern?</p>
<p>Let’s use Kriging to find out!</p>
</section>
<section id="datasets-setting-up-the-work-directory" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="datasets-setting-up-the-work-directory"><span class="header-section-number">1.2</span> Datasets &amp; setting up the work directory</h2>
<p>Before you begin do make sure to download all data by <a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114/raw/main/Week%206%20-%20Dataset.zip"><strong>clicking here</strong></a>. Create a folder on called “<strong>Week 6</strong>” within your “<strong>GEOG0114</strong>” folder stored in the desktop of your personal computer. Make sure to extract all data from the zip folder and store it into “<strong>Week 6</strong>” folder. Open a new R script and set the work directory to <strong>Week 6’s</strong> folder.</p>
<p>For Windows, the work directory will be:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/Users/AccountName/Desktop/GEOG0114/Week 6"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For MAC, the work directory will be:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/AccountName/Desktop/GEOG0114/Week 6"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="loading-and-installing-packages" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="loading-and-installing-packages"><span class="header-section-number">1.3</span> Loading and installing packages</h2>
<p>We will need to load the following packages:</p>
<ul>
<li><code>sf</code>: Simple Features</li>
<li><code>tmap</code>: Thematic Mapping</li>
<li><code>raster</code>: Raster/gridded data analysis and manipulation</li>
<li><code>sp</code>: Package for providing classes for spatial data (points, lines, polygons and grids)</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages using library() function</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sf"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tmap"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"raster"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sp"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The above packages <code>sf</code>, <code>tmap</code>, <code>raster</code> &amp; <code>sp</code> should have been installed in the previous session(s). We will need to install the following package:</p>
<ul>
<li><code>gstat</code>: provides functions for univariable and multivariable geostatistical analysis.</li>
<li><code>geoR</code>: provides additional functions for geostatistical and variogram analysis.</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the packages: gstat using the install.package()</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"gstat"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"geoR"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the packages with library()</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"gstat"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"geoR"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="loading-datasets" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="loading-datasets"><span class="header-section-number">1.4</span> Loading datasets</h2>
<p>Let us first import the quantitative data i.e., <code>US 2019 SO2 Emissions data.csv</code> into R/RStudio.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use read.csv() to import </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>datafile <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">"US 2019 SO2 Emissions data.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>NOTE</strong>: The description of the column names are as follows:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Column Name</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>CountyRef</code></td>
<td>The County &amp; State for where the air quality monitors are located in US</td>
</tr>
<tr class="even">
<td><code>Longitude</code></td>
<td>Longitude (in decimal degrees)</td>
</tr>
<tr class="odd">
<td><code>Latitude</code></td>
<td>Latitude (in decimal degrees)</td>
</tr>
<tr class="even">
<td><code>Mean_SO2</code></td>
<td>Annual Mean (ppb) concentrations of Ambient sulphur dioxide (<span class="math inline">\(SO_{2}\)</span>) in 2019</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Shape file: US National border named <code>US Nation Border.shp</code></li>
<li>Shape file: US State border named <code>US State Borders.shp</code></li>
<li>Raster: US Car Usage (5000m resolution) named <code>US Prevalence of Car Usage 5km.tif</code></li>
<li>Raster: US Urbanisation Index (5000m resolution) named <code>US Urbanisation Index 5km.tif</code></li>
<li>Raster: US Socioeconomic Deprivation (5000m resolution) named <code>US Socioeconomic Deprivation 5km.tif</code></li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use read_sf() function to load shape file </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>US_Nation_Border_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"US Nation Border.shp"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>US_State_Border_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"US State Borders.shp"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-preparation" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">1.5</span> Data preparation</h2>
<p>There are a couple of things we need to do before proceeding with the analysis:</p>
<ol type="1">
<li>The <code>datafile</code> is a data frame object in RStudio’s memory, and not a spatial object. We need to coerce into a spatial <code>sf</code> object</li>
<li>The shapefiles for <code>US Nation Border.shp</code> &amp; <code>US State Borders.shp</code> are in a different CRS called <strong>Spherical Mercator 3857</strong> which measures distance in meters and not in decimal degrees. We need to transform the <code>longitude</code> and <code>latitude</code> of our stations which are in decimal degrees to the CRS of <strong>Spherical Mercator 3857</strong></li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coerce the spreadsheet into a sf object</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># First tell R that it’s coordinates are currently in decimal degrees (i.e., WGS84 'crs = 4326') before the transformation</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>datafile_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(datafile, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Now apply the transformation from WGS84 to Mercator i.e., = 3857</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>datafile_sf_prj <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(datafile_sf, <span class="dv">3857</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the details</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(datafile_sf_prj)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The code chunk below generates an empty map with the <code>tmap</code> functions. It shows just the border of USA and the point locations for the air quality monitoring stations superimposed.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(US_Nation_Border_shp) <span class="sc">+</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>(<span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image1_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="semivariogram-analysis" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="semivariogram-analysis"><span class="header-section-number">1.6</span> Semivariogram analysis</h2>
<p>Semivariograms describe how data are related with distance by plotting the <strong>semivariance</strong> against the <strong>separation distance</strong>, known as the <strong>experimental</strong> or <strong>empirical semivariogram</strong>. The semivariance is defined as half the average squared difference between points separated by some distance <em>h</em>. As the separation distance <em>h</em> between samples increase, we would expect the semivariance to also increase (again, because near samples are more similar than distant samples).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>In the generic semivariogram shown above, there are three important parameters:</p>
<ol type="1">
<li><strong>Sill</strong>: The maximum semivariance value observed, and it indicates the threshold for values beyond (i.e., flatline) which there is no spatial autocorrelation. <strong>NOTE</strong>: the <strong>Partial Sill</strong> is a value calculated by taking the difference between the <strong>Sill</strong> and <strong>Nugget</strong> (i.e., <strong>Partial Sill = Sill - Nugget</strong>)</li>
<li><strong>Range</strong>: The maximum separation distance <em>h</em> at which we will expect to find evidence of spatial autocorrelation. A separation distance beyond the <strong>range</strong> samples are no longer correlated.</li>
<li><strong>Nugget</strong>: This describes the variance of the measurement error combined with spatially uncorrelated variations at distances shorter than the sample spacing, namely noise in the data. The larger the <strong>nugget</strong> relative to the <strong>sill</strong>, the less spatial dependence there is in the data and less useful Kriging will be.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Two important assumptions of a basic semivariogram are that the spatial process under investigation are: i.) <strong>stationary</strong>, i.e., the spatial autocorrelation between the measurements of same variables in a given area is the same for all locations; and ii.) <strong>isotropic</strong>, spatial autocorrelation is the same in every direction. If the autocorrelation differs by direction, it is termed as <strong>anisotropic</strong>.</p>
</div>
</div>
<p>To be used in Kriging, a semivariogram plot (akin to the above image) must be generated to estimate the 3 parameters (i.e., sill, nugget &amp; range) from the points termed <strong>experimental</strong> or <strong>empirical semivariogram</strong>. These are used as initial values to fit a <strong>modeled</strong> or <strong>theoretical semivariogram</strong> which can be in one of three major forms:</p>
<ol type="1">
<li>Gaussian Model (Left)</li>
<li>Spherical Model (Center)</li>
<li>Exponential Model (Right)</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_1_5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Once the modelled semivariogram has been defined, it can be used in Kriging.</p>
<section id="plotting-the-empirical-semivariogram" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="plotting-the-empirical-semivariogram"><span class="header-section-number">1.6.1</span> Plotting the Empirical Semivariogram</h3>
<p>Use the function <code>variogram()</code> to create the object for plotting the empirical variogram</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># coerce datafile_sf_prj to be a 'sp' spatial dataframe object as it's </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ---variogram does not use 'sf' objects</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ignore warning message</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>datafile_sp_prj <span class="ot">&lt;-</span> <span class="fu">as</span>(datafile_sf_prj, <span class="st">"Spatial"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># use variogram() function to compute the semivariance with a null model Mean_SO2 as outcome</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>SO2_emp.variogram <span class="ot">&lt;-</span> <span class="fu">variogram</span>(Mean_SO2<span class="sc">~</span><span class="dv">1</span>, datafile_sp_prj)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the object to reveal a table</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>SO2_emp.variogram</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>np</code> in the output is the number of paired considered within the separation distance <code>dist</code>; <code>gamma</code> is the averaged semivariance for the number of paired points within the separation distance <code>dist</code>.</p>
</div>
</div>
<p>Let us plot these values to see the empirical semivariogram</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_emp.variogram)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>From the output (i.e., plot and table), we should note the approximate values for the <code>partial sill</code>, <code>nugget</code> and <code>range</code>.</p>
<ol type="1">
<li>The <code>nugget</code> is roughly <strong>17</strong> (i.e.&nbsp;base on starting <code>gamma</code> value from the table).</li>
<li>The <code>range</code> is roughly <strong>1180000</strong> meters (i.e.&nbsp;base on peak value for <code>gamma</code> and it’s corresponding <code>dist</code>).</li>
<li>The <code>partial sill</code> is <strong>65</strong>. This is derived from the peak value for <code>gamma</code> subtracted by the <code>nugget</code> (<code>82 - 17 = 65</code>).</li>
</ol>
<p>These initial values give us an idea of what to expect when we proceed to fit a <strong>theoretical</strong> semivariogram using the <code>fit.variogram()</code>. It will help us to generate the fitted models.</p>
</section>
<section id="plotting-the-theoretical-semivariogram" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="plotting-the-theoretical-semivariogram"><span class="header-section-number">1.6.2</span> Plotting the Theoretical Semivariogram</h3>
<p>We are going to fit a model to the empirical semivariogram in order to determine the appropriate function for Kriging (i.e., spherical (<code>Sph</code>), exponential (<code>Exp</code>) or gaussian (<code>Gau</code>)).</p>
<p>We will start fitting the various models:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit exponential</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>exp_SO2_emp.variogram <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(SO2_emp.variogram, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="dv">65</span>, <span class="st">"Exp"</span>, <span class="dv">1180000</span>, <span class="dv">17</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>exp_SO2_emp.variogram</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_emp.variogram, exp_SO2_emp.variogram, <span class="at">main  =</span> <span class="st">"Exponential model (Nug: 3.6, PSill: 55.9, Range: 296255m)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Spherical</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sph_SO2_emp.variogram <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(SO2_emp.variogram, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="dv">65</span>, <span class="st">"Sph"</span>, <span class="dv">1180000</span>, <span class="dv">17</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>sph_SO2_emp.variogram</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_emp.variogram, sph_SO2_emp.variogram, <span class="at">main  =</span> <span class="st">"Spherical model (Nug: 10.5, PSill: 49.6, Range: 857452m)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit gaussian</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>gau_SO2_emp.variogram <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(SO2_emp.variogram, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="dv">65</span>, <span class="st">"Gau"</span>, <span class="dv">1180000</span>, <span class="dv">17</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>gau_SO2_emp.variogram</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_emp.variogram, gau_SO2_emp.variogram, <span class="at">main  =</span> <span class="st">"Gaussian model (Nug: 12.8, PSill: 39.1, Range: 244807m)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>By eyeballing the images - it difficult to discern whether the exponential or spherical model provides a better fit to the empirical semivariogram. We can use the <code>fit.variogram()</code> function to determine which is the best model amongst them.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the best model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>best_SO2_emp.variogram <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(SO2_emp.variogram, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Gau"</span>, <span class="st">"Sph"</span>)))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>best_SO2_emp.variogram</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>From the output (see column which says <code>model</code> and <code>row 2</code> it highlights <code>"Exp"</code>), it shows that the exponential model is the best fit with a <code>nugget = 3.6</code>, <code>Partial Sill =  55.9</code> and <code>Range = 296255m</code>. We therefore select the exponential model in our Kriging to make the spatial prediction for <span class="math inline">\(SO_{2}\)</span>. Lets proceed to Krige.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image2_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>IMPORTANT NOTES</strong>: The interpretation is as follows: the <code>nugget</code> in the exponential model is smaller than the other proposed models. It is small which is also an indication of evidence of larger spatial dependence in the concentrations for <span class="math inline">\(SO_{2}\)</span> across sampling sites in USA; A separation distance with values beyond <code>296255m</code> (where it curve starts to plateau) and beyond the semivariance’s threshold where it flat lines (sill of <code>59.5</code> (i.e., <code>55.9 + 3.6</code>)) - there should expect that the spatial autocorrelation in the observed levels of <span class="math inline">\(SO_{2}\)</span> are not present anymore.</p>
</div>
</div>
</section>
</section>
<section id="kriging-modelling-null" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="kriging-modelling-null"><span class="header-section-number">1.7</span> Kriging modelling (null)</h2>
<section id="building-a-blank-raster-template" class="level3" data-number="1.7.1">
<h3 data-number="1.7.1" class="anchored" data-anchor-id="building-a-blank-raster-template"><span class="header-section-number">1.7.1</span> Building a blank raster template</h3>
<p>Let us create a template raster for interpolation. The extent of the raster template should based on the points. We are going to make the resolution of grid be at 5000m by 5000m (5km by 5km) accordingly.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>RasterTemplate <span class="ot">&lt;-</span> <span class="fu">raster</span>(datafile_sp_prj)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">res</span>(RasterTemplate) <span class="ot">&lt;-</span> <span class="dv">5000</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next, declare template as a spatial grid</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>grid.interpolation <span class="ot">&lt;-</span> <span class="fu">as</span>(RasterTemplate, <span class="st">'SpatialGrid'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="implementing-the-spatial-interpolation-on-blank-template-using-kriging" class="level3" data-number="1.7.2">
<h3 data-number="1.7.2" class="anchored" data-anchor-id="implementing-the-spatial-interpolation-on-blank-template-using-kriging"><span class="header-section-number">1.7.2</span> Implementing the spatial interpolation on blank template using Kriging</h3>
<p>Now, we are going to use the parameters from the exponential theoretical semivariogram model to interpolate the concentrations of ambient SO2 for the entire study region</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>modelKrigingExp <span class="ot">&lt;-</span> <span class="fu">gstat</span>(<span class="at">formula =</span> Mean_SO2<span class="sc">~</span><span class="dv">1</span>, <span class="at">locations =</span> datafile_sp_prj, <span class="at">model =</span> exp_SO2_emp.variogram)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The results are stored in <code>modelKrigingExp</code> object. Lets add the results of the interpolation to our grid template using the <code>predict()</code> function</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this may take roughly 5mins</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>Kriged_SO2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelKrigingExp, grid.interpolation)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The above analysis produces two separate rasters: i.) Predicted <span class="math inline">\(SO_{2}\)</span> and ii.) Variation in <span class="math inline">\(SO_{2}\)</span>. Let export the results and make some visualisation using the <code>tmap</code> functions</p>
</section>
<section id="how-to-export-the-results-as-.tiff-format-thematic-visualisation-in-tmap" class="level3" data-number="1.7.3">
<h3 data-number="1.7.3" class="anchored" data-anchor-id="how-to-export-the-results-as-.tiff-format-thematic-visualisation-in-tmap"><span class="header-section-number">1.7.3</span> How to export the results as .tiff format thematic visualisation in <code>tmap</code></h3>
<p>Now, save both the prediction and variance a multi-layer raster (a ‘brick’ raster):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>brickedKriged_SO2_Results <span class="ot">&lt;-</span> <span class="fu">brick</span>(Kriged_SO2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can save them individually from the multi-layer raster as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate the rasters accordingly</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>exp.prediction <span class="ot">&lt;-</span> <span class="fu">raster</span>(brickedKriged_SO2_Results, <span class="at">layer =</span> <span class="dv">1</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>exp.variance <span class="ot">&lt;-</span> <span class="fu">raster</span>(brickedKriged_SO2_Results, <span class="at">layer =</span> <span class="dv">2</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  save the output locally on your computer</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(exp.prediction, <span class="st">"Predicted SO2 levels in USA.tif"</span>, <span class="at">format=</span><span class="st">"GTiff"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(exp.variance, <span class="st">"Variance SO2 levels in USA.tif"</span>, <span class="at">format=</span><span class="st">"GTiff"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="thematic-visualisation-of-raster-data-using-tmap" class="level3" data-number="1.7.4">
<h3 data-number="1.7.4" class="anchored" data-anchor-id="thematic-visualisation-of-raster-data-using-tmap"><span class="header-section-number">1.7.4</span> Thematic visualisation of raster data using <code>tmap</code></h3>
<p>We will need to perform a couple of steps before visualisation. First, we will need to mask the values of the raster predictions were made outside of US Border’s region. To do this, we use the <code>mask()</code> function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mask values of raster outside regions of US Border</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>US_Nation_Border_sp_shp <span class="ot">&lt;-</span> <span class="fu">as</span>(US_Nation_Border_shp, <span class="st">"Spatial"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>exp.prediction_masked <span class="ot">&lt;-</span> <span class="fu">mask</span>(exp.prediction, US_Nation_Border_shp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next, we are going to make the raster image sit perfectly sit within the plot’s frame using the country’s bounding box or extent. We can extract the bounding box by using <code>st_bbox()</code> function on the <code>US_Nation_Border_shp</code> shape file object, this basically gives us the extent of the region.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>frameExtent <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(US_Nation_Border_shp)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>frameExtent</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> frameExtent</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>     xmin      ymin      xmax      ymax </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="dv">13885235</span>   <span class="dv">2819925</span>  <span class="sc">-</span><span class="dv">7452828</span>   <span class="dv">6340334</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above values are essentially the coordinates that form a rectangle, a rectangular area which the USA country is bounded within. We are using this as the full plot region for the raster to prevent parts of the image not showing.</p>
</div>
</div>
<p>Now, let us visualise the predictions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(exp.prediction_masked, <span class="at">bbox =</span> frameExtent) <span class="sc">+</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_raster</span>(<span class="at">col.scale =</span> <span class="fu">tm_scale_continuous</span>(<span class="at">values =</span> <span class="st">"brewer.reds"</span>), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.legend =</span> <span class="fu">tm_legend</span>(<span class="at">title =</span> <span class="st">"Predicted SO2 ppb"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(US_State_Border_shp) <span class="sc">+</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill_alpha =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">"STUSPS"</span>, <span class="at">size =</span> <span class="st">"AREA"</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>() <span class="sc">+</span> </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image3_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The above shows the predicted concentrations of ambient <span class="math inline">\(SO_{2}\)</span>; however, the predicted surface is very smooth and it difficult to see the spatial patterns. One technique, which is sometimes useful, for raster data is to reclassify the pixels to ordered categories i.e., zones instead of pixel-point estimates.</p>
<p>We could reclassify the continuous values stored in the grids/pixels into discrete values using the following scheme:</p>
<ul>
<li>0 = <code>"&lt; 1.0 ppb"</code></li>
<li>1 = <code>"1.0-4.9 ppb"</code></li>
<li>2 = <code>"5.0-9.9 ppb"</code></li>
<li>3 = <code>"10.0-14.9 ppb"</code></li>
<li>4 = <code>"15.0-19.9 ppb"</code></li>
<li>5 = <code>"20.0-29.9 ppb"</code></li>
<li>6 = <code>"30.0-39.9 ppb"</code></li>
<li>7 = <code>"+40.0 ppb"</code></li>
</ul>
<p>You can do this by using the following code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector for the reclassification -i.e., 1st row captures values </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># --- between 0 and below 1 to reclassify a pixel as 0</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># While the 2nd row in this vector captures values between 1 and below 5 to </span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- reclassify a pixel as 1 and so on and so forth</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>reclassifyRaster <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">2</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">3</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">4</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">5</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">6</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="dv">40</span>,<span class="dv">70</span>,<span class="dv">7</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Then store the values into a matrix </span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(reclassifyRaster, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now, apply the matrix to the raster object to reclassify the pixels accordingly using the <code>reclassify()</code> function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>exp.prediction_masked_rec <span class="ot">&lt;-</span> <span class="fu">reclassify</span>(exp.prediction_masked, reclassifyRaster_Mat)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now, lets visualise the prediction zones:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(exp.prediction_masked_rec, <span class="at">bbox =</span> frameExtent) <span class="sc">+</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_raster</span>(<span class="at">col.scale =</span> <span class="fu">tm_scale_categorical</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">values =</span> <span class="st">"brewer.reds"</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"&lt;1.0 ppbs"</span>,<span class="st">"1.0-4.9 ppb"</span>,<span class="st">"5.0-9.9 ppb"</span>, <span class="st">"10.0-14.9 ppb"</span> , <span class="st">"15.0-19.9 ppb"</span>, <span class="st">"20.0-29.9 ppb"</span>, <span class="st">"30.0-39.9 ppb"</span>,<span class="st">"+40.0ppb"</span>)),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.legend =</span> <span class="fu">tm_legend</span>(<span class="at">title =</span> <span class="st">"Predicted SO2 ppb"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(US_State_Border_shp) <span class="sc">+</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill_alpha =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">"STUSPS"</span>, <span class="at">size =</span> <span class="st">"AREA"</span>) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>() <span class="sc">+</span> </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>)) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image3_2_5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>You can visualise the variance:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mask values of raster outside regions of US Border</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>exp.variance_masked <span class="ot">&lt;-</span> <span class="fu">mask</span>(exp.variance, US_Nation_Border_sp_shp)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(exp.variance_masked, <span class="at">bbox =</span> frameExtent) <span class="sc">+</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_raster</span>(<span class="at">col.scale =</span> <span class="fu">tm_scale_continuous</span>(<span class="at">values =</span> <span class="st">"brewer.oranges"</span>), </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.legend =</span> <span class="fu">tm_legend</span>(<span class="at">title =</span> <span class="st">"Variance for SO2 ppb"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(US_State_Border_shp) <span class="sc">+</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill_alpha =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">"STUSPS"</span>, <span class="at">size =</span> <span class="st">"AREA"</span>) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>() <span class="sc">+</span> </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image3_2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Again, it will be better to reclassify the raster for the variance to see where the model predicts the SO<span class="math inline">\(_2\)</span> with lower and high errors. We can use the <code>reclassify()</code> accordingly. Note that the lowest and highest estimated variance is <code>4.435438</code> and <code>57.59579</code>, respectively. Let us reclassify the variance raster using the following scheme:</p>
<ul>
<li>0 = <code>"&lt; 5.0 ppb"</code></li>
<li>1 = <code>"5.0-9.9 ppb"</code></li>
<li>2 = <code>"10.0-19.9 ppb"</code></li>
<li>3 = <code>"20.0-29.9 ppb"</code></li>
<li>4 = <code>"30.0-39.9 ppb"</code></li>
<li>5 = <code>"40.0-49.9 ppb"</code></li>
<li>6 = <code>"+50.0 ppb"</code></li>
</ul>
<p>Here is the code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_var <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">0</span>,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">1</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">2</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">3</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">4</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">5</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">6</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat_var <span class="ot">&lt;-</span> <span class="fu">matrix</span>(reclassifyRaster_var, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat_var</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>exp.variance_masked_rec <span class="ot">&lt;-</span> <span class="fu">reclassify</span>(exp.variance_masked, reclassifyRaster_Mat_var)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(exp.variance_masked_rec, <span class="at">bbox =</span> frameExtent) <span class="sc">+</span> </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_raster</span>(<span class="at">col.scale =</span> <span class="fu">tm_scale_categorical</span>(</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="st">"brewer.oranges"</span>, </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"&lt;5.0 ppbs"</span>,<span class="st">"5.0-9.9 ppb"</span>,<span class="st">"10.0-19.9 ppb"</span>, <span class="st">"20.0-29.9 ppb"</span> , <span class="st">"30.0-39.9 ppb"</span>, <span class="st">"40.0-49.9 ppb"</span>,<span class="st">"+50.0ppb"</span>)),</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.legend =</span> <span class="fu">tm_legend</span>(<span class="at">title =</span> <span class="st">"Variance for SO2 ppb"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))) <span class="sc">+</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(US_State_Border_shp) <span class="sc">+</span> </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill_alpha =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">"STUSPS"</span>, <span class="at">size =</span> <span class="st">"AREA"</span>) <span class="sc">+</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>() <span class="sc">+</span> </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>)) <span class="sc">+</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image3_4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above example was a null model. We can include risk factors as adjustments for the prediction. The below code shows you how to incorporate other variables in the analysis. We will use the other raster data sets for urbanisation, deprivation and car usage as adjustments in the Kriging model.</p>
</div>
</div>
</section>
</section>
<section id="demonstrations-of-kriging-regression-model" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="demonstrations-of-kriging-regression-model"><span class="header-section-number">1.8</span> Demonstrations of Kriging regression model</h2>
<p>The code is a repeat of the above but with regression covariate adjustment.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sf"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sp"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"raster"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tmap"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"gstat"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"geoR"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># refresh the memory by clear ALL objects in R</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># load datasets</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>datafile <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">"US 2019 SO2 Emissions data.csv"</span>, <span class="at">header=</span><span class="cn">TRUE</span>, <span class="at">sep=</span><span class="st">","</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>US_Nation_Border_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"US Nation Border.shp"</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>US_State_Borders_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"US State Borders.shp"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Coerce the spreadsheet into a sf object</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co"># First tell R that it’s coordinates are currently in decimal degrees (i.e., WGS84 'crs = 4326') before the transformation</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>datafile_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(datafile, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Now apply the transformation from WGS84 to Mercator i.e., = 3857</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>datafile_sf_prj <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(datafile_sf, <span class="dv">3857</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the details</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(datafile_sf_prj)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co"># corece to sp object</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>datafile_sp_prj <span class="ot">&lt;-</span> <span class="fu">as</span>(datafile_sf_prj, <span class="st">"Spatial"</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Load rasters. These are the covariates we will use in the gstat() function for the kriging regression</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>US_urbanisation <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="st">"US Urbanisation Index 5km.tif"</span>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>US_SVI <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="st">"US Socioeconomic Deprivation 5km.tif"</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>US_CarUsage <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="st">"US Prevalence of Car Usage 5km.tif"</span>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ignore that stupid warning message as its related to outdated 'rgdal &amp; rgeos'. All raster are in the CRS Mercator 3857</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Stack the three rasters together by using the stack() function </span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">stack</span>(US_urbanisation, US_SVI, US_CarUsage)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: from the stacked data extract the raster values on the points of pollution stations using the extract() function</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>predictors.values <span class="ot">&lt;-</span> <span class="fu">extract</span>(predictors, datafile_sp_prj)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Stitch the extraction to the spatial point data frame using the cbind() "column bind" function</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>datafile_sp_prj<span class="sc">@</span>data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(datafile_sp_prj<span class="sc">@</span>data, predictors.values)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="co"># assign proper names to columns</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(datafile_sp_prj<span class="sc">@</span>data)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"US_Urbanisation_Index_5km"</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(datafile_sp_prj<span class="sc">@</span>data)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"US_Socioeconomic_Deprivation_5km"</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(datafile_sp_prj<span class="sc">@</span>data)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">"US_Prevalence_of_Car_Usage_5km"</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="co"># You can view the dataframe to see the raster values. What has happened is we extracted the overlapping raster pixels on</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a><span class="co"># those pollution stations and assuming those are the levels of urbanisation, deprivation and car usage at those points for</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="co"># which the SO2 levels are observed. </span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(datafile_sp_prj<span class="sc">@</span>data)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Linear Regression model to determine which variables are worth to be included in the Kriging model. If the turn out</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="co"># to be statistical significant (i.e., p &lt; 0.05). Then include to include in the kriging.</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>lm.model <span class="ot">&lt;-</span> <span class="fu">lm</span>(Mean_SO2 <span class="sc">~</span> US_Urbanisation_Index_5km <span class="sc">+</span> US_Socioeconomic_Deprivation_5km <span class="sc">+</span> US_Prevalence_of_Car_Usage_5km, <span class="at">data =</span> datafile_sp_prj)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm.model)</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a><span class="co"># all variables are statistically significant. According to this model urbanisation and car usage marginally decreases SO2 levels,</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a><span class="co"># while areas of higher deprivation yields higher levels of SO2. Include all variables to the Kriging model since they are</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a><span class="co"># significant.</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: use variogram() function to compute the semivariance with variable in the model</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>SO2_adj_emp.variogram <span class="ot">&lt;-</span> <span class="fu">variogram</span>(Mean_SO2 <span class="sc">~</span> US_Urbanisation_Index_5km <span class="sc">+</span> US_Socioeconomic_Deprivation_5km <span class="sc">+</span> US_Prevalence_of_Car_Usage_5km, datafile_sp_prj)</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>SO2_adj_emp.variogram</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_adj_emp.variogram)</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Determine best model</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>best_SO2_adj_emp.variogram <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(SO2_adj_emp.variogram, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Gau"</span>, <span class="st">"Sph"</span>)))</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>best_SO2_adj_emp.variogram</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(SO2_adj_emp.variogram, best_SO2_adj_emp.variogram, <span class="at">main =</span> <span class="st">"Best Model: Exponential (Nug: 5.63, PSill: 49.4, Range: 293891.2m)"</span>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a><span class="co"># HERE ARE THE CORRECTIONS</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 8: Here is where we need to insert the raster values and not the points. In the previous iteration, I mistakenly used the</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a><span class="co"># point verison of the car usage data and adapted the code without verifying it to work. I sincerely apologise for this oversight!</span></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>modelKrigingExp_adj <span class="ot">&lt;-</span> <span class="fu">gstat</span>(<span class="at">formula =</span> Mean_SO2<span class="sc">~</span>US_Urbanisation_Index_5km <span class="sc">+</span> US_Socioeconomic_Deprivation_5km <span class="sc">+</span> US_Prevalence_of_Car_Usage_5km, <span class="at">locations =</span> datafile_sp_prj, <span class="at">model =</span> best_SO2_adj_emp.variogram)</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the stacked rasters for car usage, urbanisation and socioeconomic deprivation and convert it to a grid template</span></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Here, we need their values stored inside that grid template, to which we will apply the kriging model to make the prediction</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a><span class="co"># while at the same time make adjustments for their value.</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a><span class="co"># we created the stacked into the 'predictors' object</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>predictors.grid <span class="ot">&lt;-</span> <span class="fu">as</span>(predictors, <span class="st">"SpatialGridDataFrame"</span>)</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Last time it was just "SpatialGrid" because it was empty. This grid has values and thus not empty </span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a><span class="co"># so we call it "SpatialGridDataFrame"</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the raster's names for consistency</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(predictors.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"US_Urbanisation_Index_5km"</span>, <span class="st">"US_Socioeconomic_Deprivation_5km"</span>, <span class="st">"US_Prevalence_of_Car_Usage_5km"</span>)</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(predictors.grid)</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 9: We can now do the predictions over the SpatialGridDataFrame</span></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>Kriged_SO2_adj <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelKrigingExp_adj, predictors.grid)</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Brick the layer in order to separate the estimated prediction and variance accordingly</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>brickedKriged_SO2_Results_adj <span class="ot">&lt;-</span> <span class="fu">brick</span>(Kriged_SO2_adj)</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>exp.prediction_adj <span class="ot">&lt;-</span> <span class="fu">raster</span>(brickedKriged_SO2_Results_adj, <span class="at">layer =</span> <span class="dv">1</span>)</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>exp.variance_adj <span class="ot">&lt;-</span> <span class="fu">raster</span>(brickedKriged_SO2_Results_adj, <span class="at">layer =</span> <span class="dv">2</span>)</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 10: Masking the prediction and reclassifying the layer</span></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a><span class="co"># You can mask the prediction with the outline of USA</span></span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>US_Nation_Border_sp_shp <span class="ot">&lt;-</span> <span class="fu">as</span>(US_Nation_Border_shp, <span class="st">"Spatial"</span>)</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>exp.prediction_adj_masked <span class="ot">&lt;-</span> <span class="fu">mask</span>(exp.prediction_adj, US_Nation_Border_sp_shp)</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Run this to see minimum and maximum value.</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>exp.prediction_adj_masked</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a><span class="co"># You can see there are negative value as some of the prediction for SO2. </span></span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Lets reclassify these as an invalid prediction with value -1</span></span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>reclassifyRaster <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>,</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">2</span>,</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">3</span>,</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>    <span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">4</span>,</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>    <span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">5</span>,</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>    <span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">6</span>,</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>    <span class="dv">40</span>,<span class="dv">70</span>,<span class="dv">7</span>)</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(reclassifyRaster, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>reclassifyRaster_Mat</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the categories to masked layer in order to reclassify the predictions that were adjusted those 3 variables</span></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>exp.prediction_adj_masked_rec <span class="ot">&lt;-</span> <span class="fu">reclassify</span>(exp.prediction_adj_masked, reclassifyRaster_Mat)</span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the labels for the 'reclassifyRaster_Mat" object</span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>SO2LevelsCategories <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Invalid"</span>,<span class="st">"&lt;1.0 ppbs"</span>,<span class="st">"1.0-4.9 ppb"</span>,<span class="st">"5.0-9.9 ppb"</span>, <span class="st">"10.0-14.9 ppb"</span> , <span class="st">"15.0-19.9 ppb"</span>, <span class="st">"20.0-29.9 ppb"</span>, <span class="st">"30.0-39.9 ppb"</span>,<span class="st">"+40.0ppb"</span>)</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, we going to force the colour schemes we want. </span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a><span class="co"># We want the "Invalid" category to have a grey colour; and the rest for lowest category</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a><span class="co"># ie., "&lt;1.0ppbs" to "+40.0ppb" to be increase red intensities"</span></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Force the colorbrewer schemes grey = #636363</span></span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Force the reds (from light red down to solid-dark-red) = #fee5d9, #fcbba1, #fc9272, #fb6a4a, #ef3b2c, #cb181d, #99000d</span></span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the colour scheme for the above 'SO2LevelsCategories'</span></span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>HackedColourPalette <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#636363"</span>, <span class="st">"#fee5d9"</span>, <span class="st">"#fcbba1"</span>, <span class="st">"#fc9272"</span>, <span class="st">"#fb6a4a"</span>, <span class="st">"#ef3b2c"</span>, <span class="st">"#cb181d"</span>, <span class="st">"#a50f15"</span>, <span class="st">"#67000d"</span>)</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>frameExtent <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(US_Nation_Border_shp)</span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>frameExtent</span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 11: Visual the adjusted prediction from Universal Kriging Regression</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(exp.prediction_adj_masked_rec, <span class="at">bbox =</span> frameExtent) <span class="sc">+</span> </span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_raster</span>(<span class="at">col.scale =</span> <span class="fu">tm_scale_categorical</span>(</span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> HackedColourPalette, </span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span>  SO2LevelsCategories),</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a><span class="at">col.legend =</span> <span class="fu">tm_legend</span>(<span class="at">title =</span> <span class="st">"Predicted adjusted SO2 ppb"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))) <span class="sc">+</span></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(US_State_Borders_shp) <span class="sc">+</span> </span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">fill_alpha =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">"STUSPS"</span>, <span class="at">size =</span> <span class="st">"AREA"</span>) <span class="sc">+</span></span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(datafile_sf_prj) <span class="sc">+</span> </span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>() <span class="sc">+</span> </span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_scalebar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>)) <span class="sc">+</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/general/week6/image3_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="references-see-reading-list" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="references-see-reading-list"><span class="header-section-number">1.9</span> References (see reading list)</h2>
<ol type="1">
<li><strong>Technical Document</strong>: [R Programming] Gurpreet Singh and Biju Soman, (2020), Spatial Interpolation using Kriging in R. <a href="https://www.researchgate.net/profile/Gurpreet-Singh-183/publication/343601032_Spatial_interpolation_using_kriging_in_R/data/5f3390f2a6fdcccc43c20d3a/Spatial-interpolation-using-kriging-in-R.pdf?_sg%5B0%5D=Ox9zjHFKNoFXxoGzOO3eZtonzYqvi5LKBt84IU25txIK2YxGFuYQp96-kZNzD8Xlk9SsS7fwIJ7P1Yje1MHPGg.wf5dfrrtSj4GoBLWz3_do_QVk2whGjl0tCBt-45WueLKFrcj2fkFWkBI6Szh8nuaSkhsVHN0upqxoFuV7pYTtQ.HK05pv99BTeoysDHXvW7of8BAC3S9_e0uzhhnQdEq8M9ZC-Sr7Z-ZulLLI4I3xLuE0JWgA1A96-p29-HihUc9Q&amp;_sg%5B1%5D=YiMQs6tMalvBlWmTzIi0jKABG87VbWwU4PY6u-BDfGbolv2TzkoJbpXLDrpiD1NmGizLizQPPT5Av_ZQpl9R4R2VEcK9Qmr52p2LmRjb0peq.wf5dfrrtSj4GoBLWz3_do_QVk2whGjl0tCBt-45WueLKFrcj2fkFWkBI6Szh8nuaSkhsVHN0upqxoFuV7pYTtQ.HK05pv99BTeoysDHXvW7of8BAC3S9_e0uzhhnQdEq8M9ZC-Sr7Z-ZulLLI4I3xLuE0JWgA1A96-p29-HihUc9Q&amp;_sg%5B2%5D=2-ry5k1TH8C1tFxue0921sdsrR5DSFxdJSrPVPt-Wz5Km4X_9ftPpwzBMdPlW1yImyGxaOJ_G2zwZwY.SVz4moyyo-kgSfqcPMIgN1mOBRUMfLQTRdJl6UoOQtXFvbAYJqUa-n1_4g7_--KhC4bGWGaVo7C8vBcx9M1YEw&amp;_iepl="><strong>Download here</strong></a></li>
<li><strong>Technical Document</strong>: [R Programming] Fernando Antonanzas-Torres, (2014), Geostatistics examples in R: Ordinary Kriging, Universal Kriging and Inverse Distance Weighted. <a href="https://www.researchgate.net/profile/Fernando-Antonanzas/publication/268218675_Geostatistics_examples_in_R_ordinary_kriging_universal_kriging_and_inverse_distance_weighted/links/5465c8b80cf2052b509f5b9d/Geostatistics-examples-in-R-ordinary-kriging-universal-kriging-and-inverse-distance-weighted.pdf?_sg%5B0%5D=Mkjpzx1FsDKeIE3Lo1q2rqrsWq4ljtAtH-p_j-oWBVvgIOlkRhe4yfYyNtQOZz-LhMRtrjBmurZJUyMtfplPFg.s4Bw5xYEKdD2FNPvgh1VPmaE35AZ3mdAxQXxZz0ufA1Zft1uqIa4WDkCWO7H88fpGne1qR1KcpXHEEaKy94bMg.I3j_gqSSKDGjc-eV74OI8xSw7IOOnHcU4VggPGL2a9gBG9Uj_ddHoCJmFczOQkDqVxjsB_mwokLInnIZFVNKbg&amp;_sg%5B1%5D=Dms-97W1tB3ewXQZsY77sA0wUKF-xa51dOBC605DgRbjQ1X2XPkjf5YR9-op8AMbC5hKgAzwOaSPM75_2CgZAt-FDAbpBjaTFrMSoKehf-K6.s4Bw5xYEKdD2FNPvgh1VPmaE35AZ3mdAxQXxZz0ufA1Zft1uqIa4WDkCWO7H88fpGne1qR1KcpXHEEaKy94bMg.I3j_gqSSKDGjc-eV74OI8xSw7IOOnHcU4VggPGL2a9gBG9Uj_ddHoCJmFczOQkDqVxjsB_mwokLInnIZFVNKbg&amp;_sg%5B2%5D=KSvH3fFgAj4KplsBk1efwMm-HTXhdLTPcn_JBqO-J0qyEgbUzPNdqHj_cRJYHSSP5Y-82UHtt0xmuns.vbf9GVK0RjovGFHisDDaHgMOdhXt1gyWu0eJP_XghCtNvArd-dhZC8961ps-h79SdjYEDB9L4mnSvl8OciOj9w&amp;_iepl="><strong>Download here</strong></a></li>
<li><strong>Technical Document</strong>: [R Programming] Adela Volfova and Martin Smejkal, (2012), Geostatistical Methods in R. <a href="https://www.researchgate.net/publication/272387573_Geostatistical_Methods_in_R/fulltext/55d63b7708aec156b9a850ea/Geostatistical-Methods-in-R.pdf?_sg%5B0%5D=E5UZBMhmZTUl03YkyOT6gfvSk-S9g0IxXYiBhog_MfA9jqVOAzfTrAL3uMFSf0rrcKPuP9r3uyx6CMqQaA6bZQ.Cmagou1MIf5IxTr09yZJ-VhaHnbSDJ6y4NVO8_8-mibVZp-Gow6ZptzkVE5muRV48tnwPVS0-0k69RXQOqd_Xw.pIpgRxYsyH5s36fBIoOHiOIYoV8layFubFo7AgAin9lirZgLcebRlzWzo9omeCpcRwwfJqOs7mVjfc8QE2lrEQ&amp;_sg%5B1%5D=0nUelBLaKscENV-KeJ8660rYfLvHCPJdr9CCdXvdDdM4mdA0kk2JxyJSwF1Ymtgv9R_9naagCOgpmWgyq9Lfmwx3x5EFDIGePxNphad637Ey.Cmagou1MIf5IxTr09yZJ-VhaHnbSDJ6y4NVO8_8-mibVZp-Gow6ZptzkVE5muRV48tnwPVS0-0k69RXQOqd_Xw.pIpgRxYsyH5s36fBIoOHiOIYoV8layFubFo7AgAin9lirZgLcebRlzWzo9omeCpcRwwfJqOs7mVjfc8QE2lrEQ&amp;_sg%5B2%5D=QtqpO-j-RpX4hiitIj14MC5Gm1Gz1hZQSYmbLbJddRhf9DWkpUwzthLo5_11zPPhLWXWyi-9whnPTpo.41FOaAYvHKCCInPr1E1qE4k5xMCKLIRE1awT4SlB7Zvs3IJYERUdEGthq1WH5XTXdVPpt7yDbGXHCJQuoUlGmQ&amp;_iepl="><strong>Download here</strong></a></li>
<li><strong>Book</strong>: [R Programming] Roger S. Bivand, Edzer J. Pebesma and Virgilio Gomez-Rubio, (2008), Applied Spatial Data Analysis with R, Chapter 8: Interpolation and Geostatistics, pages 191 to 235.</li>
<li><strong>Book</strong>: [R Programming] Michael Dorman, (2014), Learning R for Geospatial Analysis, Chapter 8: Spatial Interpolation of Point Data, pages 241 to 279.</li>
<li><strong>Book</strong>: [Theory] Christopher D. Lloyd, (2010), Spatial Data Analysis: An Introduction for GIS Users, Chapter 9: Spatial Interpolation (Section 9.7. Ordinary Kriging), pages 140 to 150.</li>
</ol>
</section>
<section id="data-sources" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="data-sources"><span class="header-section-number">1.10</span> Data Sources</h2>
<ol type="1">
<li>The pollution data was obtained from the United States Environmental Protection Agency (EPA) <a href="https://aqs.epa.gov/aqsweb/airdata/download_files.html"><strong>Click Here</strong></a></li>
<li>Spatial data concerning car usage in the US was sourced from the ACS Vehicle Availability Variables project <a href="https://www.arcgis.com/home/item.html?id=9a9e43ec1603446880c50d4ed1df2207"><strong>Click Here</strong></a>. You would need to have Online ArcGIS account to access the resources.</li>
<li>US raster data for Social Vulnerability Index 2018 and Urbanization Index (2015) were sourced from the NASA Socioeconomic Data &amp; Applications Center (SEDAC) <a href="https://sedac.ciesin.columbia.edu"><strong>Click Here</strong></a>. <strong>NOTE</strong>: Registration required for free access to raster records.</li>
<li>The Global Atlas for Helminths Infections (GAHI) <a href="https://www.thiswormyworld.org"><strong>Click Here</strong></a></li>
<li>Expanded Special Project for Elimination of Neglected Tropical Diseases (ESPEN-NTD) <a href="https://espen.afro.who.int"><strong>Click Here</strong></a></li>
</ol>
</section>
<section id="exercise" class="level2" data-number="1.11">
<h2 data-number="1.11" class="anchored" data-anchor-id="exercise"><span class="header-section-number">1.11</span> Exercise</h2>
<p><strong>Case study: Village survey of hookworm infection in Uganda and Tanzania</strong></p>
<p>We will use data on the prevalence of hookworm collected from 393 villages in Uganda and Tanzania. The dataset includes coordinates for each village, which have been geo-referenced to a specific longitude and latitude, as well as the boundaries of the study area for the two countries:</p>
<ul>
<li>Point data: <code>Soil_Transmitted_Helminth_Data.csv</code></li>
<li>Shapefile of region: <code>Study_Area_UG_TZ.shp</code></li>
<li>Shapefile of region with districts: <code>Study_Area_UG_TZ_Districts.shp</code></li>
</ul>
<p>These data can be downloaded <a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114/raw/main/Week%206%20-%20Homework%20Dataset.zip"><strong>[HERE]</strong></a></p>
<p>As shown in the practical, this analysis involves going through five stages:</p>
<ol type="1">
<li>Data preparation and checking the distribution of points within the study area</li>
<li>Variogram analysis for generating an empirical variogram</li>
<li>Variogram analysis for generating a theoretical variogram to determine the appropriate model</li>
<li>Geostatistical prediction (Ordinary Kriging [null model])</li>
<li>Thematic mapping and visualisation.</li>
</ol>
<p>Use Kriging to generate a predicted prevalence map of Hookworm infection for the entire study area in Uganda and Tanzania. The World Health Organisation has a classification for grading disease burden of this type of illness in the Global South:</p>
<ul>
<li>Areas with prevalence of &lt; 1% are deemed as “Negligible”</li>
<li>Areas with a prevalence from 1% to 10% are deemed “Low risk”</li>
<li>Areas with a prevalence from 10% to 20% are deemed “Moderate risk”</li>
<li>Areas with a prevalence from 20% to 50% are deemed “High risk”</li>
<li>Areas with a prevalence from 50% and more are zones where risks are “Excessive”</li>
</ul>
<p>Produce an output that reflect the WHO’s classification for this disease.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Have a go at these questions before using solution codes which can be downloaded from <a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114/raw/main/Solutions%206.zip"><strong>[HERE]</strong></a></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./07-suitability_mapping_Niche.html" class="pagination-link" aria-label="Week 5: Ecological Niche Models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Week 5: Ecological Niche Models</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-spatial_lag_error_regressions.html" class="pagination-link" aria-label="Week 7: Spatial Lag &amp; Error Regression">
        <span class="nav-page-text">Week 7: Spatial Lag &amp; Error Regression</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/UCLPG-MSC-SGDS/GEOG0114/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>